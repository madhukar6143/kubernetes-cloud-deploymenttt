name: Deploy React App to OCI OKE

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Oracle  # <-- preserved here

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to OCIR
        run: |
          docker login iad.ocir.io \
            -u "idbjsjqzktkm/madhukar.eppalapelly@gmail.com" \
            -p "${{ secrets.OCIR_PASSWORD }}"

      - name: Build & Push Docker Image
        run: |
          IMAGE=iad.ocir.io/idbjsjqzktkm/react-app:latest
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Install kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure Kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > kubeconfig.yaml
          chmod 600 kubeconfig.yaml
          echo "KUBECONFIG=$PWD/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Deploy to OKE
        run: kubectl apply -f k8s/ --kubeconfig kubeconfig.yaml --validate=false
